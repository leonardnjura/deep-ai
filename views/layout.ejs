<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />

    <link
      rel="stylesheet"
      href="https://bootswatch.com/4/slate/bootstrap.min.css"
    />

    <link
      rel="stylesheet"
      href="https://use.fontawesome.com/releases/v5.2.0/css/all.css"
    />

    <link
      rel="stylesheet"
      href="//cdn.materialdesignicons.com/4.4.95/css/materialdesignicons.min.css"
    />

    <title>Welcome to Deep A.I.</title>
  </head>
  <body>
    <div class="container">
      <%- body %>
    </div>

    <script
      src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
      integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
      integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
      integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
      crossorigin="anonymous"
    ></script>
    <script src="https://cdnjs.deepai.org/deepai.min.js"></script>
    <script>
      deepai.setApiKey('8011831a-8564-4113-9773-605a769cf2d9');

      const defaultImage =
        'https://user-images.githubusercontent.com/39657549/66860707-616a4c80-ef96-11e9-8d9f-70ce9bf7ca67.jpg';
      const testButton = document.querySelector('#test-button');

      testButton.onclick = function() {
        const imageUrl = $('#image-url').val();
        if (validURL(imageUrl)) {
          analyzeImage(imageUrl);
        } else {
          analyzeImage();
        }
      };

      $('#preview').click(function() {
        $('#imageUpload').trigger('click');
      });

      async function analyzeImage(imageUrl = '') {
        $('#rpt').html(
          '<i class="mdi mdi-chart-donut-variant mdi-48px mdi-spin"></i> Working..'
        );
        if (!imageUrl) {
          // alert('No [valid] image url, checking local upload..');
          if (!imageUpload.files[0]) {
            alert('Please select local upload..');
            $('#rpt').html('ðŸ¤” You astound me..');
            return;
          } else {
            var result = await deepai.callStandardApi('content-moderation', {
              image: document.getElementById('imageUpload')
            });
          }
        } else {
          // alert('Good url..');
          var result = await deepai.callStandardApi('content-moderation', {
            image: imageUrl
          });
        }
        await deepai.renderResultIntoElement(
          result,
          document.getElementById('rpt')
        );
      }

      // xtras
      function readURL(input) {
        if (input.files && input.files[0]) {
          var reader = new FileReader();

          reader.onload = function(e) {
            $('#preview').attr('src', e.target.result);
            $('#rpt').html(
              '<h5>File ready</h5><small>Click analyze to detect NSFW noodz!</small>'
            );
          };

          reader.readAsDataURL(input.files[0]);
        }
      }

      $('#imageUpload').change(function() {
        readURL(this);
      });

      function validURL(str) {
        var pattern = new RegExp(
          '^(https?:\\/\\/)?' + // protocol
          '((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|' + // domain name
          '((\\d{1,3}\\.){3}\\d{1,3}))' + // OR ip (v4) address
          '(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*' + // port and path
          '(\\?[;&a-z\\d%_.~+=-]*)?' + // query string
            '(\\#[-a-z\\d_]*)?$',
          'i'
        ); // fragment locator
        return !!pattern.test(str);
      }
    </script>
  </body>
</html>
